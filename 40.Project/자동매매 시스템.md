

일단 현재는 봇은 돌아가는데 backend에서 bot의 logs데이터를 가져오지 못한다. 아마 경로 문제일듯?

기술스택 : 파이썬, 셀레니움, JSON
서비스 : 클로드, GPT, 업비트, Streamlit

# AutoTrading 시스템 아키텍처 및 데이터 플로우 가이드

## 시스템 구조 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                        EC2 INSTANCE                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   Trading Bot   │    │   FastAPI       │    │   React      │ │
│  │   (Python)      │    │   Backend       │    │   Frontend   │ │
│  │                 │    │                 │    │              │ │
│  │ Port: Internal  │    │ Port: 8001      │    │ Port: 3000   │ │
│  │                 │    │                 │    │              │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│           │                       │                      │      │
│           │                       │                      │      │
│           ▼                       ▲                      ▲      │
│  ┌─────────────────┐              │              ┌───────────┐  │
│  │   Log Files     │──────────────┘              │   Nginx   │  │
│  │   (JSON)        │                             │  (React   │  │
│  │                 │                             │ Container)│  │
│  │ logs/trades_*.json                            │           │  │
│  │ logs/analysis_*.json                          │ Port: 80  │  │
│  └─────────────────┘                             └───────────┘  │
│                                                         │        │
└─────────────────────────────────────────────────────────────────┘
                                                            │
                                                ┌───────────▼────────────┐
                                                │      인터넷            │
                                                │                        │
                                                │  사용자 브라우저        │
                                                │  http://ec2-ip:3000    │
                                                │  http://ec2-ip:8001    │
                                                └────────────────────────┘
```

## 컴포넌트 상세 분석

### 1. 트레이딩 봇 (핵심 Python 프로그램)

**파일**: `main.py`

**기능**:

- 백그라운드에서 지속적으로 실행
- Upbit API 호출로 거래 실행
- AI 기반 트레이딩 의사결정
- JSON 로그 파일에 데이터 기록
- **네트워크 포트 없음** (내부 전용)

**프로세스**:

```python
# 트레이딩 봇 실행 흐름
while True:
    market_data = fetch_upbit_data()
    ai_decision = analyze_with_ai(market_data)
    execute_trade(ai_decision)
    log_to_json(trade_result)
    time.sleep(interval)
```

### 2. 로그 파일 (데이터 저장소)

**디렉토리 구조**:

```
logs/
├── trades_20250801.json      # 거래 내역
├── analysis_20250801.json    # 시장 분석 데이터
└── errors_20250801.log       # 에러 로그
```

**데이터 형식**:

```json
{
  "timestamp": "2025-08-01T12:00:00Z",
  "action": "buy",
  "symbol": "KRW-BTC",
  "amount": 0.001,
  "price": 45000000,
  "ai_confidence": 0.85
}
```

### 3. FastAPI 백엔드 (데이터 서버)

**파일**: `web/backend/main.py` **포트**: 8001 (인터넷 노출)

**기능**:

- JSON 로그 파일 읽기
- REST API 엔드포인트 제공
- 실시간 업데이트용 WebSocket
- 데이터 가공 및 통계 계산

**API 엔드포인트**:

```python
# 주요 API 경로
GET /api/trades         # 거래 내역
GET /api/analysis       # 시장 분석 데이터
GET /api/portfolio      # 현재 포트폴리오
GET /api/performance    # 성과 지표
WS  /ws                # 실시간 업데이트
```

### 4. React 프론트엔드 (사용자 인터페이스)

**파일**: `web/frontend/src/App.js` **포트**: 3000 (인터넷 노출)

**기능**:

- 차트가 포함된 아름다운 대시보드
- FastAPI 백엔드에서 데이터 가져오기
- 실시간 트레이딩 성과 표시
- 반응형 웹 인터페이스

**컴포넌트 구조**:

```jsx
<App>
  <Dashboard>
    <PortfolioChart />
    <TradingHistory />
    <PerformanceMetrics />
    <RealTimeUpdates />
  </Dashboard>
</App>
```

### 5. Nginx (웹 서버)

**위치**: React 컨테이너 내부 **포트**: 80 (컨테이너 내부) → 3000 (호스트)

**기능**:

- React 빌드 파일 서빙
- HTTP 요청 처리
- 정적 파일 캐싱
- 프록시 리버스 설정

## 데이터 플로우 프로세스

### Step 1: 트레이딩 봇 운영

```
트레이딩 봇 → Upbit API → 트레이딩 결정 → JSON 로그 파일
```

### Step 2: 백엔드 데이터 서빙

```
FastAPI 백엔드 → JSON 파일 읽기 → API 엔드포인트 서빙
```

### Step 3: 프론트엔드 표시

```
React 프론트엔드 → 백엔드 API 호출 → 차트 및 UI 업데이트
```

### Step 4: 사용자 접근

```
사용자 브라우저 → HTTP 요청 → Nginx → React 앱 → API 호출 → 데이터 표시
```

## Docker 컨테이너 통신

### 네트워크 구조

```yaml
# docker-compose.web.yml 네트워크 구조
networks:
  trading-network:  # 내부 Docker 네트워크

services:
  autotrading-bot:     # 외부 포트 없음
    - 작성: ./logs (공유 볼륨)
    
  api-server:          # 포트 8001 → 인터넷
    - 읽기: ./logs (공유 볼륨)
    - 서빙: REST API + WebSocket
    
  web-dashboard:       # 포트 3000 → 인터넷
    - 호출: api-server:8001 (내부)
    - 서빙: React UI (Nginx 경유)
```

### 컨테이너 간 통신

```
autotrading-bot ──(파일 공유)──> api-server
                                      │
                                      │ (HTTP API)
                                      ▼
                              web-dashboard
```

## 에러 디버깅 가이드

### 1. 트레이딩 봇 문제

```bash
# 봇 로그 확인
docker-compose -f docker-compose.web.yml logs autotrading-bot

# 로그 파일 생성 확인
ls -la logs/

# 실시간 로그 모니터링
docker-compose -f docker-compose.web.yml logs -f autotrading-bot
```

**일반적인 문제**:

- API 키 오류
- 네트워크 연결 문제
- OpenAI 라이브러리 버전 충돌

### 2. 백엔드 API 문제

```bash
# API 서버 로그 확인
docker-compose -f docker-compose.web.yml logs api-server

# API 직접 테스트
curl http://localhost:8001/api/portfolio
curl http://localhost:8001/docs

# 헬스 체크
curl http://localhost:8001/health
```

**일반적인 문제**:

- JSON 파일 읽기 권한
- 포트 충돌
- 의존성 패키지 누락

### 3. 프론트엔드 문제

```bash
# 프론트엔드 로그 확인
docker-compose -f docker-compose.web.yml logs web-dashboard

# 브라우저에서 네트워크 탭 확인
# 개발자 도구 → Network 탭에서 API 호출 상태 확인
```

**일반적인 문제**:

- API 호출 실패 (CORS 에러)
- React 빌드 실패
- Nginx 설정 오류

### 4. 컨테이너 통신 문제

```bash
# 모든 컨테이너 실행 상태 확인
docker ps

# 내부 네트워크 확인
docker network ls
docker network inspect autotrading_trading-network

# 컨테이너 간 연결 테스트
docker exec -it autotrading-api curl http://autotrading-bot:8000/health
```

## 핵심 포인트

### 아키텍처 설계 원칙

1. **관심사 분리**: 트레이딩 로직, 데이터 서빙, UI가 독립적
2. **파일 기반 통신**: 봇과 백엔드 간 JSON 파일로 데이터 교환
3. **HTTP API 통신**: 백엔드와 프론트엔드 간 REST API 사용
4. **컨테이너화**: 각 서비스가 독립적인 Docker 컨테이너에서 실행

### 네트워크 보안

- **트레이딩 봇**: 외부 포트 노출 없음 (보안)
- **API 서버**: 8001 포트만 노출
- **웹 대시보드**: 3000 포트만 노출
- **내부 통신**: Docker 네트워크를 통한 보안 통신

### 확장성

- **수평 확장**: 여러 트레이딩 봇 인스턴스 실행 가능
- **데이터 백업**: JSON 로그 파일 기반으로 쉬운 백업
- **모니터링**: 각 컴포넌트 독립적 로그 및 메트릭

### 유지보수성

- **모듈화된 구조**: 각 서비스 독립적 업데이트 가능
- **표준화된 인터페이스**: REST API 및 JSON 데이터 형식
- **컨테이너 기반**: 환경 일관성 보장

이 아키텍처는 트레이딩 로직, 데이터 서빙, 사용자 인터페이스를 독립적인 컴포넌트로 분리하여 각각이 파일과 HTTP API를 통해 통신하도록 설계되었습니다.


	디버깅 : httpx문제는 버전 다운으로 해결함


To rebuild and deploy your Docker containers on EC2 with the frontend API fix:

  1. First, commit and push the frontend changes:
  git add web/frontend/src/App.js
  git commit -m "Fix frontend API URL for production deployment"
  git push

  2. On your EC2 server, pull the latest changes:
  git pull

  3. Rebuild the containers with the web compose file:
  docker-compose -f docker-compose.web.yml down
  docker-compose -f docker-compose.web.yml build --no-cache
  docker-compose -f docker-compose.web.yml up -d

  4. Check container status:
  docker-compose -f docker-compose.web.yml ps

  5. Check logs to ensure everything is working:
  docker-compose -f docker-compose.web.yml logs -f

  The frontend will now use /api in production (which nginx will proxy to your backend) instead of     
   trying to connect to localhost:8001.

  For your nginx configuration, you'll need to proxy /api/* requests to
  http://autotrading-api:8001/api/* so the frontend can reach your backend through the same
  domain.
# 모든 서비스 로그 확인
docker-compose -f docker-compose.web.yml logs

# 실시간 로그 보기 (tail -f와 같은 효과)
docker-compose -f docker-compose.web.yml logs -f

# 최근 로그만 확인 (마지막 100줄)
docker-compose -f docker-compose.web.yml logs --tail=100